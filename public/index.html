<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Festract</title>
        <link href="styles/style.css" rel="stylesheet" type="text/css">
        <script src="spotify.js"></script>
        <script src="https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    </head>
    <body onload="">
        <input type="text" id="url" placeholder="Image URL" />
        <input type="button" id="go_button" value="Run" />
        <div id="create_playlist">
            <a href="/create_playlist">Login to Spotify</a>
        </div> 
        <div id="real_create_playlist">
            <input type="button" id="real_create_playlist" value="Create Festival Playlist on Spotify" />   
        <div id="ocr_image"> </div>
        <div id="ocr_results"> </div>
        <div id="ocr_status"> </div>  
        <div id="nice_results"> </div>
        <div id="search_artists_test"> </div>  
        <div id="top_track_test"> </div>
    </body>
</html>

<script>

/**
 * Obtains parameters from the hash of the URL
 * @return Object
 */
function getHashParams() {
    var hashParams = {};
    var e, r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
    while ( e = r.exec(q)) {
        hashParams[e[1]] = decodeURIComponent(e[2]);
    }
    return hashParams;
}

var testArtists = ["beyonce", "radiohead"];
var testOCRArtists;

document.getElementById("go_button")
.addEventListener("click", function(e) {
    clearResults();
    var url = document.getElementById("url").value;
    displayImage(url);
    var textOCR = runOCR(url);
});

document.getElementById("real_create_playlist")
.addEventListener("click", function(e) {
    var params = getHashParams();

    var access_token = params.access_token,
        refresh_token = params.refresh_token,
        error = params.error;

    var userID = "";
    var playlistID = "";
    //var tracks = {uris: []};

    
    getUsername(access_token)
        .then(function(user) {
            userID = user.id;
            createPlaylist(user.id, namePlaylist(), access_token)
            .then(function(playlist) {

            playlistID = playlist.id;

            for (let i of testArtists) {
                searchArtist(i)
                .then(function(artist) {
                    /*
                    getTopTrack(artist.artists.items[0].id)
                    .then(function(track) {
                        tracks.uris.push(track.tracks[0].uri);
                    });
                    */

                    getTopTrack(artist.artists.items[0].id)
                    .then(function(track) {
                        addTrack(userID, playlistID, track.tracks[0].uri, access_token);
                    })
                });
            }

        });
        });           

});

function displayImage(url) {
    document.getElementById("ocr_image")
    .innerHTML = "Parsing text from the following image:<br><img src='" + url + "' class='responsive-image'>";
}

function runOCR(url) {
    Tesseract.recognize(url)
        .then(function(result) {
            document.getElementById("ocr_results")
            .innerText = result.text;
            testOCRArtists = createArtistList(result.text);
        }).progress(function(result) {
            document.getElementById("ocr_status")
            .innerText = result["status"] + " (" +
            (result["progress"] * 100) + "%)";
        });
    
}

// Create Playlist name from date and time string
function namePlaylist() {
    console.log("generating playlist name");
    var d = new Date();
    var name = "Festract - " + d.toString();
    console.log("playlist name: " + name);
    return name;
}

// Convert gross OCR results into a list
function createArtistList(rawText) {
    var separators = /\s\W\s/;
    var list = rawText.split(separators);
    return list;
    /*
    var listString = "";
    var i;
    for (i = 0; i < list.length; i++) {
        listString += "\n" + list[i]; 
    }
    document.getElementById("nice_results")
    .innerText = listString;
    */
}

// Clear current image and details
function clearResults() {
    document.getElementById("ocr_image")
    .innerHTML = " ";
    document.getElementById("ocr_results")
    .innerHTML = " ";
    document.getElementById("ocr_status")
    .innerHTML = " ";
    document.getElementById("nice_results")
    .innerHTML = " ";
}

</script>
        
