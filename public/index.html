<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Tesseract Test</title>
        <link href="styles/style.css" rel="stylesheet" type="text/css">
        <script src="https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    </head>
    <body onload="">
        <input type="text" id="url" placeholder="Image URL" />
        <input type="button" id="go_button" value="Run" />
        <div id="create_playlist">
            <a href="/create_playlist">Create Festival Playlist on Spotify</a>
        </div> 
        <div id="real_create_playlist">
            <input type="button" id="real_create_playlist" value="Create Festival Playlist on Spotify" />   
        <div id="ocr_image"> </div>
        <div id="ocr_results"> </div>
        <div id="ocr_status"> </div>  
        <div id="nice_results"> </div>
        <div id="search_artists_test"> </div>  
        <div id="top_track_test"> </div>
    </body>
</html>

<script>

var testArtists = ["beyonce", "radiohead"];

document.getElementById("go_button")
.addEventListener("click", function(e) {
    clearResults();
    var url = document.getElementById("url").value;
    displayImage(url);
    var textOCR = runOCR(url);
});

document.getElementById("real_create_playlist")
.addEventListener("click", function(e) {
    searchArtists(testArtists, function(artist) {
        console.log("searching...");
        getTopTrack(artist, function(track) {
            console.log("found track: " + track);
        });
    });
});

function displayImage(url) {
    document.getElementById("ocr_image")
    .innerHTML = "Parsing text from the following image:<br><img src='" + url + "' class='responsive-image'>";
}

function runOCR(url) {
    Tesseract.recognize(url)
        .then(function(result) {
            document.getElementById("ocr_results")
            .innerText = result.text;
            createArtistList(result.text);
        }).progress(function(result) {
            document.getElementById("ocr_status")
            .innerText = result["status"] + " (" +
            (result["progress"] * 100) + "%)";
        });
    
    }

// Convert gross OCR results into a list
function createArtistList(rawText) {
    var separators = /\s\W\s/;
    var list = rawText.split(separators);
    /*
    var listString = "";
    var i;
    for (i = 0; i < list.length; i++) {
        listString += "\n" + list[i]; 
    }
    document.getElementById("nice_results")
    .innerText = listString;
    */
}

// Search for artists on Spotify
function searchArtists(artists, callback) {
    document.getElementById("search_artists_test")
    .innerText = "searchin'";
    var artist = artists[0];
    var url = "https://api.spotify.com/v1/search?q=" + artist + "&type=artist";

    $.ajax(url, {
        method: 'GET',
        dataType: 'json',
        success: function(r) {
            console.log("searched for " + artist + " at " + url);
            callback(r.artists.items[0].id);
        }
    });
}

// Get artist's top track on Spotify
function getTopTrack(artistID, callback) {
    console.log("need to find top track for " + artistID);

    var url = "https://api.spotify.com/v1/artists/" + artistID + "/top-tracks?country=US";

    $.ajax(url, {
        method: 'GET',
        dataType: 'json',
        success: function(r) {
            callback(r.tracks[0].id);
        }
    });
}

// Clear current image and details
function clearResults() {
    document.getElementById("ocr_image")
    .innerHTML = " ";
    document.getElementById("ocr_results")
    .innerHTML = " ";
    document.getElementById("ocr_status")
    .innerHTML = " ";
    document.getElementById("nice_results")
    .innerHTML = " ";
}
/*
// Authorize Spotify user
function doLogin() {

}
*/
// Generate Spotify playlist

</script>
        
